{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="prediction-container">
    <form id="playerPredictionForm" method="post" class="prediction-form">
        {% csrf_token %}
        <div class="team-selection-section">
            <div class="team-selection home-team">
                <img src="" alt="Player Image" id="playerImage" class="team-logo">
                <label for="id_player_name">PLAYER NAME</label>
                {{ form.player_name }}
                {{ form.player_name.errors }}
            </div>
            <div class="vs-section">VS.</div>
            <div class="team-selection away-team">
                <img src="" alt="Opponent Team Logo" id="opponentTeamLogo" class="team-logo">
                <label for="id_opponent_team">OPPONENT TEAM</label>
                {{ form.opponent_team }}
                {{ form.opponent_team.errors }}
            </div>
        </div>
        <div class="vegas-line-section">
            <div class="vegas-line-label">PREDICTED OVER SCORE</div>
            <div class="vegas-line-input">
                {{ form.score_threshold }}
                {{ form.score_threshold.errors }}
            </div>            
        </div>
        <div class="button-container">
            <button type="submit" class="predict-button">Predict</button>
        </div>      
    </form>
</div>

<div id="predictionResult" class="prediction-result"></div>
{% endblock %}

{% block extra_css %}
<link href="{% static 'css/playerpoints.css' %}" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        $('.django-select2').select2();

        function updatePlayerImage(playerId) {
            if (playerId) {
                $.getJSON('/playerpoints/api/get_player_image_url/', {player_id: playerId}, function(data) {
                    if (data.picture_url) {
                        $('#playerImage').hide().attr('src', data.picture_url).fadeIn(300);
                    } else {
                        $('#playerImage').attr('src', ''); 
                    }
                }).fail(function() {
                    console.error("Error: Could not retrieve player image.");
                    $('#playerImage').attr('src', ''); 
                });
            }
        }

        $('#id_player_name').on('change', function() {
            var playerId = $(this).val();  
            updatePlayerImage(playerId); 
        });

        $('#id_opponent_team').on('change', function() {
            var teamInput = $(this).val();
            $.ajax({
                url: "{% url 'overunder:get_team_logo' %}",
                type: 'GET',
                data: { 'team_input': teamInput },
                success: function(data) {
                    $('#opponentTeamLogo').hide().attr('src', data.logo_url).fadeIn(300);
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching logo:', error);
                    $('#opponentTeamLogo').attr('src', ''); 
                }
            });
        });

        $('#id_player_name').val('269').trigger('change'); 
        $('#id_opponent_team').val('17').trigger('change'); 

        $('#playerPredictionForm').on('submit', function(e) {
            e.preventDefault();
            var formData = $(this).serialize();
            $.ajax({
                url: "{% url 'playerpoints:player_predictions' %}",
                type: "POST",
                data: formData,
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                },
                success: function(data) {
                    var resultDiv = $('#predictionResult');
                    if (data.error) {
                        resultDiv.html(`<p>Error: ${data.error}</p>`).addClass('active');
                    } else {
                        resultDiv.html(`
                            <p>Accuracy: ${data.accuracy}%</p>
                            <p>Precision: ${data.precision}%</p>
                            <p>Recall: ${data.recall}%</p>
                            <p>F1-Score: ${data.f1_score}%</p>
                        `).addClass('active');
                    }
                    $('html, body').animate({
                        scrollTop: resultDiv.offset().top
                    }, 1000);
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', error);
                }
            });
        });
    });
</script>
{% endblock %}
